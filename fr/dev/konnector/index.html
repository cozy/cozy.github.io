<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="CozyCloud - https://cozy.io">
        <link rel="canonical" href="https://docs.cozy.io/dev/konnector/">
        <link rel="shortcut icon" href="../../img/favicon.png">
        
        <title>Créez votre premier connecteur - Documentation Cozy</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
            <link href="../../css/extra.css" rel="stylesheet">
            <link href="../../css/highlight_theme.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://docs.cozy.io/">Documentation Cozy</a>
            <a class="navbar-brand" href="https://docs.cozy.io/en">en</a>
            <a class="navbar-brand" href="https://docs.cozy.io/fr/index_fr">fr</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../../index_fr/">Accueil</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Utiliser <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../use/index_fr/">Utiliser Cozy</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Synchroniser <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../sync/">Restez synchro</a>
</li>
                            
<li >
    <a href="../../sync/phone/">Synchronisez vos téléphones</a>
</li>
                            
<li >
    <a href="../../sync/desktop/">Synchronisez vos ordinateurs</a>
</li>
                            
<li >
    <a href="../../sync/linux/">Installer sur GNU/Linux</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../download/">Télécharger</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Installer <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../install/">Install Cozy on your own server</a>
</li>
                            
<li >
    <a href="../../install/debian/">Debian</a>
</li>
                            
<li >
    <a href="../../install/manual/">Installation manuelle</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Développer <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../">Introduction</a>
</li>
                            
<li >
    <a href="../intro/">Architecture</a>
</li>
                            
<li >
    <a href="../app/">Créez votre première application</a>
</li>
                            
<li class="active">
    <a href="./">Créez votre premier connecteur</a>
</li>
                            
<li >
    <a href="../cordova/">Créez une application mobile avec Cordova</a>
</li>
                            
<li >
    <a href="../sendmail/">Envoyer un courriel</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li>
                        <a href="https://github.com/cozy/cozy-docs-v3/">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#how-to-write-a-connector">How to write a connector</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#how-does-it-work">How does it work ?</a></li>
            <li><a href="#lets-create-our-first-connector">Let’s create our first connector</a></li>
            <li><a href="#linking-with-a-cozy-and-dev-mode">Linking with a cozy and dev mode</a></li>
            <li><a href="#integration-in-cozy-collect-for-all-the-users">Integration in cozy-collect for all the users</a></li>
            <li><a href="#faq">FAQ</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="how-to-write-a-connector">How to write a connector<a class="headerlink" href="#how-to-write-a-connector" title="Permanent link">&para;</a></h1><h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2><p>A connector is a simple script which imports data from other web services and put it in your cozy.
Each connector is an independant application, managed by the <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a>
application.</p><p>To protect your data, each connector runs inside a container in order to sandbox all their
interactions with your data.</p><h2 id="how-does-it-work">How does it work ?<a class="headerlink" href="#how-does-it-work" title="Permanent link">&para;</a></h2><p>A connector is a NodeJS script. The target node version used to run your connector is the
<a href="https://nodejs.org">current LTS version</a> (8 at the moment).</p><p>Like client side apps, connectors communicate with the <a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a>
using its API, and get an auth token every time they start. They need to register with a manifest,
and ask permissions to the user.</p><p>To ease the development of a connector, a npm package, named <a href="https://github.com/cozy/cozy-konnector-libs">cozy-konnector-libs</a>
provides some shared libraries which are adapted to be used for a connector :</p><ul>
<li><a href="https://cheerio.js.org">cheerio</a> to easily request html pages like jQuery</li><li><a href="https://github.com/request/request-promise">request-promise</a>: 
<a href="https://github.com/request/request">request</a> wrapped in promises</li><li><a href="https://github.com/request/request-debug">request-debug</a> which displays all the requests and
   responses in the standard output. Check &ldquo;debug&rdquo; option in 
<a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_requestFactory">requestFactory</a></li></ul>
<p>But you may need some other npm packages not integrated in <a href="https://github.com/cozy/cozy-konnector-libs">cozy-konnector-libs</a> to help you run your connector :</p><ul>
<li><a href="http://momentjs.com/docs/">momentjs</a> or 
<a href="https://date-fns.org">date-fns</a> to manage dates</li><li><a href="http://bluebirdjs.com">bluebird</a> to get enhanced promises</li></ul>
<p>When the connector is started, it also gets some data through environment variables:</p><ul>
<li><code>COZY_CREDENTIALS</code> : the auth token used by 
<a href="https://cozy.github.io/cozy-client-js/">cozy-client-js</a> to communicate with the server</li><li><code>COZY_URL</code> : the API entry point</li><li><code>COZY_FIELDS</code> : the settings coming from 
<a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> and filled by the user of the connector (login, password, directory path).</li></ul>
<p>Those variables are used by the BaseKonnector and the cozy-client to configure the connection to
the <a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a> with the right permissions as defined in your manifest.konnector. These are
simulated in standalone mode so that you don&rsquo;t need a real cozy stack to develop your connector.</p><p><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#basekonnector">More information</a></p><p>From the server point of view, each connector is a <code>job</code> that is run periodically via a 
<code>trigger</code>. 
<a href="https://cozy.github.io/cozy-stack/jobs.html">More information</a></p><h2 id="lets-create-our-first-connector">Let’s create our first connector<a class="headerlink" href="#lets-create-our-first-connector" title="Permanent link">&para;</a></h2><p>The easiest way to create a new connector is to use <a href="https://github.com/cozy/cozy-konnector-template">cozy-konnector-template</a>:</p><h3 id="cozy-konnector-template-and-standalone-mode"><a href="https://github.com/cozy/cozy-konnector-template">cozy-konnector-template</a> and standalone mode<a class="headerlink" href="#cozy-konnector-template-and-standalone-mode" title="Permanent link">&para;</a></h3><pre class="codehilite"><code class="language-sh">git clone https://github.com/cozy/cozy-konnector-template cozy-konnector-monservice
cd cozy-konnector-monservice
yarn # or npm install</code></pre>


<p><em>note: the Cozy Team uses <code>yarn</code>, but if you prefer <code>npm</code>, just keep using it, everything should just work.</em></p><p>The connector template is ready with demo code to show you how to scrape a fictional
website: <a href="http://books.toscrape.com">books.toscrape.com</a>, for which you do not need to have
credentials.</p><p>As indicated in the README, just run it:</p><pre class="codehilite"><code class="language-sh">yarn standalone</code></pre>


<p>The first run will create a <code>konnector-dev-config.json</code> file which allows you to configure the input
of the connector when running it in the CLI.</p><pre class="codehilite"><code class="language-javascript">{
  &quot;COZY_URL&quot;: &quot;http://cozy.tools:8080&quot;,
  &quot;fields&quot;: {}
}</code></pre>


<p><code>COZY_URL</code> is for later, but the 
<code>fields</code> attribute will allow you to define credentials to the
target web service, like 
<code>login</code> and 
<code>password</code> as if they would come from a real 
<a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a>.</p><p>This way to run the connector is the <em>standalone</em> mode. In this mode, 
<code>cozyClient</code> is stubbed and
all data meant to be saved in a cozy is displayed in the standard output and files are directly
saved in the root directory of the connector. This is useful to first develop your connector
without handling the state of a real 
<a href="https://cozy.github.io/cozy-stack/">Cozy Stack</a>.</p><p>You have more documentation about this in the <a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/cli.md">CLI section of the documentation</a>.</p><h3 id="connector-structure">Connector structure<a class="headerlink" href="#connector-structure" title="Permanent link">&para;</a></h3><p>Basically, a connector is just a function passed to the BaseKonnector constructor, and which
eventually returns a promise:</p><p>To create the connector, just create a new instance of BaseKonnector with the function as argument</p><pre class="codehilite"><code class="language-javascript">const {BaseKonnector} = require('cozy-konnector-libs')

module.exports = new BaseKonnector(fields =&gt; {
  // use fields to get user credentials and choices
  console.log(fields, 'fields')
})</code></pre>


<h4 id="fetch-operations">Fetch operations<a class="headerlink" href="#fetch-operations" title="Permanent link">&para;</a></h4><p>Every time the connector is run, it will call the function and wait for the resolution of the
returned promise. This function can then log into the remote site, fetch data and save it in the
form of an array of objects with specific attributes expected by the different saving functions
(<code>saveFiles</code>, 
<code>addData</code>, 
<code>filterData</code>, 
<code>saveBills</code>).</p><p>A basic connector workflow involves:</p><ul>
<li>getting data and storing them into a variable. You can get the data by calling an API, scraping the remote website…</li><li>filtering data to remove the ones already present inside the database using <a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_filterData">filterData</a></li><li>save the filtered data into the database (<a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#adddata">addData</a>)</li><li>save the related files using (<a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#savefiles">saveFiles</a>)</li></ul>
<h4 id="error-handling">Error handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h4><p>If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the <a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> application and will display an explicit error to the user:</p><ul>
<li><code>LOGIN_FAILED</code>: the konnector could not login</li><li><code>NOT_EXISTING_DIRECTORY</code>: the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector)</li><li><code>UNKNOWN_ERROR</code>: there was an unexpected error, please take a look at the logs to know what appened</li><li><code>VENDOR_DOWN</code>: the target web site is down now</li><li><code>USER_ACTION_NEEDED</code>: The user needs to login to the service to do manual actions (could be Terms Of Service to validate)</li></ul>
<p>You can get the list of error codes in <code>require(&lsquo;cozy-konnector-libs&rsquo;).errors</code></p><pre class="codehilite"><code class="language-javascript">const {BaseKonnector, errors} = require('cozy-konnector-libs')

module.exports = new BaseKonnector(fields =&gt; {
    // Here, the following message will be displayed in cozy-collect : &quot;Bad credentials. Check the konnector fields and run the connection again.&quot;
    throw new Error(errors.LOGIN_FAILED)
})</code></pre>


<h4 id="cozy-konnector-libs"><a href="https://github.com/cozy/cozy-konnector-libs">cozy-konnector-libs</a><a class="headerlink" href="#cozy-konnector-libs" title="Permanent link">&para;</a></h4><p>The Cozy Konnector Libs provide several useful methods for common tasks:</p><ul>
<li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#basekonnector">BaseKonnector</a>: creates the connector and fetches data</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#cozyclient">cozyClient</a> gives an instance of 
<a href="https://cozy.github.io/cozy-client-js/">cozy-client-js</a> already initialized according to 
<code>COZY_URL</code>, and 
<code>COZY_CREDENTIALS</code></li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#module_requestFactory">requestFactory</a> a function which returns an instance of request-promise initialized with defaults often used in connector development.</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/3cad316bac1898ef3c2656577af786f6549b40b0/packages/cozy-logger/src/index.js#L35-L41">log</a> allows to log messages with different levels</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#filterdata">filterData</a> to filter data</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#adddata">addData</a> to add Data to the cozy</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#linkbankoperations">linkBankOperations</a> to link a bill to a bank operation</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#savebills">saveBills</a> which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills</li><li><a href="https://github.com/cozy/cozy-konnector-libs/blob/master/packages/cozy-konnector-libs/docs/api.md#updateorcreate">updateOrCreate</a> create or update documents inside database</li></ul>
<h2 id="linking-with-a-cozy-and-dev-mode">Linking with a cozy and dev mode<a class="headerlink" href="#linking-with-a-cozy-and-dev-mode" title="Permanent link">&para;</a></h2><p>Once your connector is able to gather data from the targeted web service in standalone mode. Now is
the time to put this data in a real cozy. Here comes the dev mode.</p><p>But before doing that, your connector needs more setup : a <code>manifest.konnector</code> file and

<code>konnector-dev-config.json</code>&lsquo;s 
<code>COZY_URL</code> section.</p><h3 id="the-manifest">The manifest<a class="headerlink" href="#the-manifest" title="Permanent link">&para;</a></h3><p>Each connector is described by a manifest. This is a JSON file named <code>manifest.konnector</code> at the root of your code folder. It should include the following minimal information:</p><pre class="codehilite"><code>{
  &quot;name&quot;: &quot;konnector name&quot;,
  &quot;type&quot;: &quot;node&quot;,
  &quot;slug&quot;: &quot;konnectorslug&quot;,
  &quot;description&quot;: &quot;description&quot;,
  &quot;source&quot;: &quot;git://github.com/cozy/cozy-konnector-thename.git&quot;,
  &quot;permissions&quot;: {
    &quot;accounts&quot;: {
      &quot;description&quot;: &quot;Required to get the account's data&quot;,
      &quot;type&quot;: &quot;io.cozy.accounts&quot;,
      &quot;verbs&quot;: [&quot;GET&quot;]
    }
  }
}</code></pre>


<p><a href="https://github.com/cozy/cozy-konnector-template">cozy-konnector-template</a> already has a manifest which you can customize.</p><p>You may add some permissions for your own doctype. <a href="https://cozy.github.io/cozy-stack/konnectors.html">Here</a> is the detailed list of fields for a
connector manifest file.</p><p>You can also get more information on permissions in the official <a href="https://github.com/cozy/cozy-stack/blob/master/docs/permissions.md">cozy-stack documentation</a></p><h3 id="konnector-dev-configjson">konnector-dev-config.json<a class="headerlink" href="#konnector-dev-configjson" title="Permanent link">&para;</a></h3><p>If you want to put data from your connector to a real cozy, your must define where to find this
cozy, and this must be a cozy for which you have the credentials.</p><p>Here comes the <code>COZY_URL</code> in konnector-dev-config.json which defines just that.</p><p>Then you just have to run:</p><pre class="codehilite"><code class="language-sh">yarn dev</code></pre>


<p>And for the first run, the CLI will open a tab in your browser asking you to give permissions to the
connector and the connector will save data directly in your cozy. This will validate that your
manifest has the needed permissions on the data you want to save.</p><p>this is the <em>dev</em> mode</p><h2 id="integration-in-cozy-collect-for-all-the-users">Integration in cozy-collect for all the users<a class="headerlink" href="#integration-in-cozy-collect-for-all-the-users" title="Permanent link">&para;</a></h2><p>To run a connector, we do not want the cozy to install all dependencies of the connector each time
it installs it.</p><p>To avoid this, the connectors need to be compiled into one file in a dedicated branch of the
repository and the repository needs to be a public git repository. The <code>package.json</code> file
from 
<a href="https://github.com/cozy/cozy-konnector-template">cozy-konnector-template</a> gives you the commands to do this : 
<code>yarn build</code> and 
<code>yarn deploy</code> 
but the last one needs to be configured in 
<code>package.json</code></p><p>Once your public git repository is configured, you only have to declare it.</p><p>Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But
at the moment, you need to declare your new connector on the <a href="https://forum.cozy.io">cozy forum</a>.
The Cozy team will review your code and add your connector to the 
<a href="https://github.com/cozy/cozy-collect">Cozy Collect</a> application.</p><h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2><h3 id="how-do-i-scrap-a-website">How do I scrap a website<a class="headerlink" href="#how-do-i-scrap-a-website" title="Permanent link">&para;</a></h3><p>Use the request function from <a href="https://github.com/cozy/cozy-konnector-libs">cozy-konnector-libs</a> with the proper options</p><p>Here’s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill:</p><pre class="codehilite"><code class="language-javascript">const {BaseKonnector, requestFactory} = require('cozy-konnector-libs')
const rq = requestFactory({
  jar: true, // handle the cookies like a browser
  json: false, // do not try to parse the result as a json document
  cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio)
})
const moment = require('moment')

module.exports = new BaseKonnector(function fetch (fields) {
  return rq(&quot;https://login.remote.web&quot;)
  .then($ =&gt; { // the result is automatically wrapped with cheerio and you can use it like jQuery
    const form = {
      form: {
        login: fields.login,
        password: fields.password,
        csrf_token: $('[name=&quot;csrf_token&quot;]').val(),
      }
    }
    return rq({
      method: 'POST',
      form
    })
  })
  .then($ =&gt; rq(&quot;https://admin.remote.web/bills&quot;))
  .then($ =&gt; {
    return [{date: moment($(&quot;#bill_date&quot;)), value: $(&quot;#bill_value&quot;)}]
  })
  .then(entries =&gt; addData(entries, 'io.cozy.bills'))
})</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//piwik.cozycloud.cc/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '7']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <noscript><p><img src="//piwik.cozycloud.cc/piwik.php?idsite=7&rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Piwik Code -->
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../extra.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
